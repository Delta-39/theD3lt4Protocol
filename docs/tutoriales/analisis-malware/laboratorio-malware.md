# Arma tu propio laboratorio para analisis de malware

En este artículo, aprenderás a configurar un laboratorio para el análisis de malware utilizando REMnux y FLARE VM. Este entorno te permitirá realizar análisis estáticos y dinámicos de muestras maliciosas en un entorno controlado y seguro.

---

## Prerrequisitos

Antes de comenzar, asegúrate de contar con lo siguiente:

- **Hardware**: Al menos 12 GB de RAM disponibles para las máquinas virtuales.
- **Software**:
    - [VirtualBox](https://www.virtualbox.org/)
    - [REMnux](https://remnux.org/)
    - [FLARE VM](https://github.com/mandiant/flare-vm)
- Sistema Operativo Windows 10 para la máquina de FLARE VM.

---

## Paso 1: Configurar la Red en VirtualBox

1. Abre VirtualBox y ve a `Herramientas > Red`.
2. En la pestaña de "Redes solo-anfitrion", haz clic en el icono de añadir para crear una nueva red solo-anfitrion.
![malware1](../../assets/malware%20lab/malware1.png)
3. Selecciona la red creada y haz clic en el icono de ajustes:
   - Activa `Habilitar el servidor DHCP`.
   - Configura el rango de direcciones IP según sea necesario.
![malware2](../../assets/malware%20lab/malware2.png)

4. Asigna la red a los adaptadores de las máquinas virtuales:
   - Ve a la configuración de cada máquina virtual.
   - En la sección "Red", selecciona `Adaptador 1` y configúralo como `solo-anfitrion`.
![malware3](../../assets/malware%20lab/malware3.png)
![malware4](../../assets/malware%20lab/malware4.png)
---

## Paso 2: Configurar REMnux

1. Descarga el archivo ISO de REMnux desde su [sitio oficial](https://remnux.org/).
2. Crea una nueva máquina virtual en VirtualBox:
   - `Tipo`: Linux
   - `Versión`: Ubuntu (64-bit)
   - Asigna al menos 2 GB de RAM y 2 CPUs.
3. Monta la imagen ISO de REMnux en la máquina virtual.
4. Sigue las instrucciones del instalador para completar la instalación.
5. Instala los Guest Additions:
    - Ve al menú de VirtualBox `Dispositivos > Insertar imagen de CD de las Guest Additions`.
    - Crearemos el punto de montaje para instalar los Guest Additions
        ```bash
        mount <ruta al dev donde esta el guest addiotion> /media/cdrom
        ```
        ![malware5](../../assets/malware%20lab/malware5.png)
    - Nos dirigiremos a /home/remnux/media/cdrom y ejecutaremos el **`autorun.sh`**
        ![malware6](../../assets/malware%20lab/malware6.png)
    >La carpeta /media/cdrom las cree yo usando el comando **`mkdir`**
6. Reinicia la máquina virtual.

---

## Paso 3: Configurar FLARE VM

Antes de comenzar con esta instalacion te recomiendo tomar variios `snapshots` a lo largo de esta instalacion. De todas maneras voy indicarte los que fui tomando yo para que los tengas de referencia.

??? note "¿Que es un snapshot en virtualizadores?"
    Un snapshot (instantánea) en virtualización es una captura completa del estado de una máquina virtual en un momento específico.

1. Crea una nueva máquina virtual en VirtualBox:
    - `Tipo`: Microsoft Windows
    - `Versión`: Windows 10 (64-bit)
    - Asigna al menos 4 GB de RAM y 2 CPUs.
2. Instala Windows 10 en la máquina virtual.
    - Tomar snapshot

3. **Instalar guest addons**:
    - Mismo proceso anterior, insertamos la imagen iso de los guest addons
        ![malware7](../../assets/malware%20lab/malware7.png)
    - Procedemos a abrir el cd e instalarlo
    - Tomar snapshot

        ![malware8](../../assets/malware%20lab/malware8.png)

4. **Desactivar Windows Defender y actualizaciones automaticas**:
    - Este paso es sumamente importante debido a que si no lo hacemos no podremos instalar la maquina FLARE VM.

5. Descarga e instala FLARE VM siguiendo las instrucciones del repositorio oficial:
    - Nos dirigiremos al repo de [Flare VM](https://github.com/mandiant/flare-vm) y descargaremos este repo en zip
    - Nos dirigiremos a la carpeta en donde esta el repo descargado.
    - Correremos el siguiente comando
        ```powershell
        Unblock-File .\install.ps1
        ```
        ![malware9](../../assets/malware%20lab/malware9.png)
    - Activaremos la ejecucion de scripts
        ```powershell
        Set-ExecutionPolicy Unrestricted -Force
        ```
    - Finalmente correremos el instalador
        ```powershell
        .\install.ps1
        ```
        ![malware10](../../assets/malware%20lab/malware10.png)
>Esta instalacion tarda MUCHO asique tener paciencia

    ![malware11](../../assets/malware%20lab/malware11.png)
    ![malware12](../../assets/malware%20lab/malware12.png)

6. Tomar snapshot
7. Reinicia la máquina virtual una vez completada la instalación.

---

## Paso 4: Configuración de remnux inetsim

1. Iremos a nuestra maquina remnux y configuraremos **`inetsim`**:
    - En REMnux, ejecuta:
        ```bash
        nano /etc/inetsim/inetsim.conf
        ```
        ![malware13](../../assets/malware%20lab/malware13.png)
    - Descomentaremos los siguientes servicios:
        ![malware14](../../assets/malware%20lab/malware14.png)
    - Colocaremos la direccion ip de nuestro remnux en los siguientes apartados:
        ![malware15](../../assets/malware%20lab/malware15.png)
        ![malware16](../../assets/malware%20lab/malware16.png)
    - En FLARE VM, tendremos que cambiar el servidor dns que usamos, y colocar la direccion ip de nuestro REMnux
        - Iremos a Panel de Control > Redes e Internet > Conexiones de Red > Propiedades Ethernet > Protocolo ipv4
        - Colocaremos como dns preferido la direccion ip de nuestro REMnux
            ![malware17](../../assets/malware%20lab/malware17.png)
    - Volveremos a la maquina REMnux y activaremos el servicio **`inetsim`**
        ```bash
        sudo inetsim
        ```
        ![malware18](../../assets/malware%20lab/malware18.png)
    - Iremos a la maquinda FLARE VM, y abriremos cualquier navegador web que tengamos, si nos aparece lo siguiente, realizamos esta configuracion de manera exitosa
        ![malware19](../../assets/malware%20lab/malware19.png)
    - Tomar snapshot de FLARE VM.

??? note "Inetsim"
    INetSim es una herramienta incluida en REMnux diseñada para simular servicios de red comunes, como HTTP, DNS, FTP, y otros, en un entorno controlado. Su propósito principal es analizar el comportamiento de malware que intenta comunicarse con servicios externos, permitiendo observar sus acciones sin riesgos para redes reales.

---

## Paso 5: Buenas Prácticas

- Asegúrate de que las máquinas virtuales no tengan acceso a Internet para evitar cualquier riesgo de propagación de malware.
- Toma instantáneas (snapshots) de las máquinas virtuales después de la instalación y configuración inicial.

---

¡Felicidades! Ahora tienes un laboratorio funcional para analizar malware de forma segura.


